<apex:page controller="SldsForgotPasswordController"  showHeader="false" standardStyleSheets="false" sidebar="false"  docType="html-5.0">
 <apex:stylesheet value="{!URLFOR($Resource.LightningCSS, 'assets/styles/salesforce-lightning-design-system-vf.css')}" />
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <apex:includeScript value="{!URLFOR($Resource.AngularJS15)}" />
    <style>
    	a{
    		text-decoration : none !important;
    		cursor : pointer;
    	}
      #loading-image {
            position: fixed;
            top: 40%;
            left: 47%;
            width:4%;
        } 
        #loading { 
            width: 100%;
            height: 100%;
            top: 0px;
            left: 0px;
            position: absolute;
            display:block;
            opacity: 0.5;
            filter: alpha(opacity = 50);
            -moz-opacity: 0.5;
            background-color: #fff;
            text-align: center;
            z-index: 9005;
        }
	    .required{
	    	color : red;
	    }
    </style>
    <script>
    var myApp = angular.module('myApp', []);
        	myApp.service('DataService', function($q) {              
            	this.forgotPassword = function (externaluserWrapperstring,pageurl,startURL){
            		console.log(JSON.stringify(externaluserWrapperstring) + 'externaluserWrapperstring');
                 	var deferred = $q.defer();
             		Visualforce.remoting.Manager.invokeAction(
                		'{!$RemoteAction.SldsForgotPasswordController.forgotPassword}',angular.toJson(externaluserWrapperstring),pageurl,function (result, event) {
	                	if (event.type == 'exception') {
		                    console.log('called'+result);  
		                    deferred.reject(event.message);
		                } else {
		                	console.log(result + 'startURL');
		                	deferred.resolve(result);
		                	}
		            }, 
		            {escape: false}
		            );
             		return deferred.promise;
           		}
           		this.redirectToLogin = function(){
           			var deferred = $q.defer();
             			Visualforce.remoting.Manager.invokeAction(
                		'{!$RemoteAction.SldsForgotPasswordController.redirectToLogin}',function (result, event) {
	                	if (event.type == 'exception') {
		                    console.log('called'+result);  
		                    deferred.reject(event.message);
		                } else {
		                	console.log(result + 'startURL');
		                	deferred.resolve(result);
		                }
		            }, 
		            {escape: false}
		            );
             		return deferred.promise;
           		
           		}
            });
            myApp.controller('LoginCtrl', ['$scope', 'DataService','$timeout',function($scope,DataService,$timeout){  
           	$scope.isloading = false;
            $scope.errors = [];
            $scope.errors.push('');
            $scope.validateData = function(){
	           	$scope.errors = [];
	           	if (($scope.username === null) || angular.isUndefined($scope.username) || ($scope.username.length === 0)) {
	           		$scope.errors.push('Username is required');
	           	}
	           
           		$scope.isloading = false;
	           	if($scope.errors.length == 0){
	           		return true;
	           	}
	           	else{
	           		return false;
	           	}
            }
            $scope.getParameterByName = function(name) {
						  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
						  var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
							  results = regex.exec(location.search);
						  return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}
			$scope.singleerror = '';
			$scope.cancel = function(){
				$scope.isloading = true;
				DataService.redirectToLogin().then(
                        function (successfulSearchResult) {
                            $scope.isloading =false;
                            $(location).attr('href',successfulSearchResult);
                        },function (errorSearchResult) {
                            $scope.singleerror = errorSearchResult;
                           var singleerror =  $scope.singleerror.replace("[","").replace("]","");
                            $scope.errors.push(singleerror);
                            $scope.isloading = false;
                            console.log($scope.singleerror.replace("[").replace("]") + '$scope.singleerror');
                        }
                    )
			
			}
            $scope.forgotPassword = function(){
            	$scope.isloading = true;
            	var startURL= $scope.getParameterByName('startURL');
            	if($scope.validateData()){
            		var externaluserWrapperstring={
                    "username" : $scope.username,
                   
                    }
            		DataService.forgotPassword(externaluserWrapperstring,location.toString(),startURL).then(
                        function (successfulSearchResult) {
                            $scope.isloading =false;
                            console.log('inside cusss');
                             $timeout(function () { $(".success").text('Mail send successfully.Please check your emailid'); } , 5000);
                            $(location).attr('href',successfulSearchResult);
                        },function (errorSearchResult) {
                            $scope.singleerror = errorSearchResult;
                           var singleerror =  $scope.singleerror.replace("[","").replace("]","");
                            $scope.errors.push(singleerror);
                            $scope.isloading = false;
                            console.log($scope.singleerror.replace("[").replace("]") + '$scope.singleerror');
                        }
                    )
                }               
           	}
         }]);
    </script>
    <html  xmlns="http://www.w3.org/2000/svg" 
    xmlns:xlink="http://www.w3.org/1999/xlink" ng-app="myApp" ng-controller="LoginCtrl">
        <body style="background-color: #ddd">
        <div class="slds" >
<<<<<<< HEAD
        	<apex:pagemessages />
=======
        	<apex:pagemessages/>
>>>>>>> c9ae441995b5eadb029ce72dd456e341b9e959da
        	<div class="errorouterdiv" style="min-height:20px">
	        	<div class="slds-warning" ng-repeat="error in errors track by $index" style="color: red;">
					        	{{error}}
					
	        	</div>
        	</div>
        	<div class="success" style="color:green">
        	</div>
	        <div class="slds-scrollable--y">
	        	<div class="slds-form--horizontal" style="padding-top : 7%">
	        		<div class="slds-form-element" style="width: 50%;">
      					<apex:image url="{!URLFOR($Resource.DealerVuResources,'images/logo1.gif')}" width="149px"/>
        			</div>
        			<div class="slds-form-element" style="width: 60%;">
      					<div class="slds-text-heading--label">
	        			Please enter Username to send you link to change your password
	        			</div>
	        		</div>	
    				<div class="slds-form-element">
      					<label class="slds-form-element__label" for="inputSample2">User Name</label>
      					<abbr class="required" title="required">*</abbr>
	      				<div class="slds-form-element__control ">
	        				<input id="inputSample2"  required="required" class="slds-input slds-size--1-of-3" type="text" placeholder="Placeholder Text" ng-model="username" />
	      				</div>
      				</div>
      				<div class="slds-form-element" style="padding-left: 36%;padding-top: 1%;">
	      				<div class="slds-grid" role="group">
	                            <button type="button" class="slds-size--1-of-7 slds-button slds-button--neutral" ng-click="cancel();">Cancel</button>
								 <button type="button" class="slds-size--1-of-7 slds-button slds-button--neutral" ng-click="forgotPassword();">Continue</button> 
	            
						</div>
				 	</div>
      			</div>
      		</div>
      	</div>
      	<div class="slds-spinner--medium" id="loading" ng-if="isloading">
	                <img ng-show="isloading" id="loading-image" src="{!URLFOR($Resource.LightningCSS, '/assets/images/spinners/slds_spinner_brand.gif')}" alt="Loading..." />
       </div>
       </body>
     </html>			
</apex:page>